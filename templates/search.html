{% extends 'base.html' %}
{% block title %}Search Schools ‚Äî HanapEskwela{% endblock %}
{% block content %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />

<style>
  /* Reuse styles from index */
  .search-container {
    padding: 20px;
    background: white;
    display: flex;
    justify-content: center;
    align-items: center; 
    gap: 10px;
    position: sticky;
    top: 0;
    z-index: 900;
    box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
    flex-wrap: wrap; 
  }
  .search-input { width: 300px; padding: 10px 15px; border-radius: 20px; border: 1px solid #ddd; outline: none; }
  .filter-select { padding: 10px; border-radius: 20px; border: 1px solid #ddd; }
  
  .gps-btn {
    padding: 10px 15px; border-radius: 20px; border: none; background: #FF9800;
    color: white; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 5px;
  }
  .gps-btn.active { background: #4CAF50; }

  .grid {
    display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 25px; padding: 40px; background: #f9f9f9; min-height: 80vh;
  }
  
  .school-card {
    background: white; border-radius: 12px; overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08); transition: transform 0.2s; cursor: pointer; position: relative;
  }
  .school-card:hover { transform: translateY(-5px); box-shadow: 0 8px 16px rgba(0,0,0,0.12); }
  .card-img { height: 150px; width: 100%; object-fit: cover; }
  .card-body { padding: 15px; }
  .card-title { margin: 0 0 5px 0; font-size: 18px; color: #333; }
  .card-meta { font-size: 13px; color: #666; display: flex; align-items: center; gap: 5px; margin-bottom: 5px; }
  
  .fav-icon {
    position: absolute; top: 10px; right: 10px; background: white; border-radius: 50%;
    width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;
    font-size: 18px; color: #ccc; z-index: 2; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  }
  .fav-icon:hover { transform: scale(1.1); color: #999; }
  .fav-icon.active { color: #f44336; }

  /* Modal Styles */
  .modal-overlay {
    display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.7); z-index: 1000; justify-content: center; align-items: center; padding: 20px;
  }
  .modal-content {
    background: white; width: 100%; max-width: 900px; height: 90vh; border-radius: 16px;
    display: flex; overflow: hidden; position: relative;
  }
  .modal-left { width: 45%; background: #f5f5f5; display: flex; flex-direction: column; }
  .modal-right { width: 55%; padding: 30px; overflow-y: auto; }
  .modal-img { width: 100%; height: 200px; object-fit: cover; }
  .map-container { flex: 1; background: #e0e0e0; position: relative; width: 100%; min-height: 250px; }
  #map { width: 100%; height: 100%; z-index: 1; }
  .modal-close {
    position: absolute; top: 20px; right: 20px; background: #eee; border: none;
    border-radius: 50%; width: 36px; height: 36px; cursor: pointer; font-size: 20px; z-index: 10;
  }
  .detail-row { margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 15px; }
  .detail-label { font-size: 12px; font-weight: bold; color: #2E7D32; text-transform: uppercase; display: block; margin-bottom: 4px; }
  .action-btn {
    display: inline-block; background: #2E7D32; color: white; padding: 12px 24px;
    border-radius: 8px; text-decoration: none; font-weight: 600; margin-top: 20px; text-align: center;
  }
  
  @media (max-width: 768px) {
    .modal-content { flex-direction: column; height: auto; max-height: 90vh; }
    .modal-left, .modal-right { width: 100%; }
  }
</style>

<div class="search-container">
  <input class="search-input" id="search" placeholder="Search schools, courses..." oninput="filterSchools()">
  <select class="filter-select" id="filter" onchange="filterSchools()">
    <option value="all">All Types</option>
    <option value="public">Public</option>
    <option value="private">Private</option>
  </select>
  <select class="filter-select" id="favFilter" onchange="filterSchools()">
    <option value="all">All Schools</option>
    <option value="fav">My Favorites</option>
  </select>
  <button id="gps-btn" class="gps-btn" onclick="requestUserLocation()">
    üìç Enable GPS
  </button>
</div>

<div class="grid" id="schoolGrid">
  </div>

<div class="modal-overlay" id="modal">
  <div class="modal-content">
    <button class="modal-close" onclick="closeModal()">√ó</button>
    <div class="modal-left">
      <img id="m-img" class="modal-img" src="">
      <div class="map-container"><div id="map"></div></div>
    </div>
    <div class="modal-right">
      <h2 id="m-name" style="margin-top:0;">School Name</h2>
      <p id="m-desc" style="color:#555;"></p>
      
      <div style="display:flex; gap:20px; margin-top:20px; margin-bottom:20px;">
        <div><span class="detail-label">Type</span> <span id="m-type"></span></div>
        <div><span class="detail-label">Views</span> <span id="m-views"></span></div>
        <div><span class="detail-label">Status</span> <span id="m-slots"></span></div>
      </div>

      <div class="detail-row"><span class="detail-label">Location</span><div id="m-addr"></div></div>
      <div class="detail-row"><span class="detail-label">Programs</span><div id="m-progs"></div></div>
      <div class="detail-row"><span class="detail-label">Tuition</span><div id="m-tuition" style="color:#d84315;"></div></div>
      <div class="detail-row">
        <span class="detail-label">Contact</span>
        <div>üìû <a id="m-contact" href="#"></a></div>
        <div>üåê <a id="m-socials" href="#" target="_blank"></a></div>
      </div>

      <a id="m-link" href="#" target="_blank" class="action-btn">Visit Website</a>
      <button id="m-fav-btn" class="action-btn" style="background:#f5f5f5; color:#333; margin-left:10px;" onclick="toggleModalFav()">‚ô° Add to Favorites</button>
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>

<script>
const schools = {{ schools | tojson }};
let map = null;
let userLat = null;
let userLng = null;
let currentSchoolId = null;
let routingControl = null;

function renderSchools(list) {
  const grid = document.getElementById('schoolGrid');
  grid.innerHTML = '';
  if(list.length === 0) { grid.innerHTML = '<p style="text-align:center; grid-column:1/-1;">No schools found.</p>'; return; }

  list.forEach(s => {
    const div = document.createElement('div');
    div.className = 'school-card';
    div.onclick = (e) => { if(!e.target.classList.contains('fav-icon')) openModal(s.id); };
    div.innerHTML = `
      <div class="fav-icon ${s.is_fav ? 'active' : ''}" data-id="${s.id}" onclick="event.stopPropagation(); toggleFav('${s.id}', this)">‚ô•</div>
      <img src="${s.img}" class="card-img" onerror="this.src='https://via.placeholder.com/400x200'">
      <div class="card-body">
        <h3 class="card-title">${s.name}</h3>
        <div class="card-meta">üìç ${s.place}</div>
        <div class="card-meta">üí∞ ${s.tuition}</div>
      </div>
    `;
    grid.appendChild(div);
  });
}

function filterSchools() {
  const q = document.getElementById('search').value.toLowerCase();
  const type = document.getElementById('filter').value;
  const fav = document.getElementById('favFilter').value;
  
  const filtered = schools.filter(s => {
    return (s.name.toLowerCase().includes(q) || (s.programs && s.programs.toLowerCase().includes(q))) &&
           (type === 'all' || s.type === type) &&
           (fav === 'all' || s.is_fav);
  });
  renderSchools(filtered);
}

function toggleFav(id, btn) {
  btn.classList.toggle('active');
  fetch('/api/toggle_favorite', {
    method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({school_id: id})
  }).then(res => { if(res.status === 401) window.location.href = "{{ url_for('login') }}"; return res.json(); })
  .then(data => {
    const s = schools.find(x => x.id === id);
    if(s) s.is_fav = (data.status === 'added');
  });
}

function toggleModalFav() {
    toggleFav(currentSchoolId, document.querySelector(`.fav-icon[data-id="${currentSchoolId}"]`));
    const btn = document.getElementById('m-fav-btn');
    const s = schools.find(x => x.id === currentSchoolId);
    // Simple UI update, re-open modal to sync fully or just toggle text
    if(btn.innerText.includes("Add")) {
        btn.innerText = "‚ô• Remove Favorite"; btn.style.color = "red";
    } else {
        btn.innerText = "‚ô° Add to Favorites"; btn.style.color = "#333";
    }
}

function openModal(id) {
  const s = schools.find(x => x.id === id);
  if(!s) return;
  currentSchoolId = id;

  // Track View
  fetch('/api/view_school', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({school_id: id}) })
  .then(r=>r.json()).then(d => document.getElementById('m-views').innerText = d.views || s.views);

  document.getElementById('modal').style.display = 'flex';
  document.getElementById('m-name').innerText = s.name;
  document.getElementById('m-img').src = s.img;
  document.getElementById('m-desc').innerText = s.desc || 'No description.';
  document.getElementById('m-type').innerText = s.type;
  document.getElementById('m-slots').innerText = s.slots;
  document.getElementById('m-addr').innerText = s.address;
  document.getElementById('m-progs').innerText = s.programs;
  document.getElementById('m-tuition').innerText = s.tuition;
  document.getElementById('m-link').href = s.link;
  
  // Fav Button State
  const favBtn = document.getElementById('m-fav-btn');
  if(s.is_fav) { favBtn.innerText = "‚ô• Remove Favorite"; favBtn.style.color = "red"; }
  else { favBtn.innerText = "‚ô° Add to Favorites"; favBtn.style.color = "#333"; }

  // Modal Map
  setTimeout(() => {
    if (!map) {
      map = L.map('map').setView([14.2, 121.2], 10);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap' }).addTo(map);
    }
    map.invalidateSize();
    map.eachLayer((layer) => { if (!!layer.toGeoJSON) map.removeLayer(layer); });
    if (routingControl) { map.removeControl(routingControl); routingControl = null; }
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    L.marker([s.lat || 14.2, s.lng || 121.1]).addTo(map).bindPopup(s.name).openPopup();

    if (userLat && userLng && s.lat && s.lng) {
        routingControl = L.Routing.control({
            waypoints: [L.latLng(userLat, userLng), L.latLng(s.lat, s.lng)],
            lineOptions: { styles: [{color: '#2E7D32', opacity: 0.8, weight: 6}] },
            createMarker: function() { return null; }, addWaypoints: false
        }).addTo(map);
    } else {
        map.setView([s.lat || 14.2, s.lng || 121.1], 13);
    }
  }, 200);
}

function closeModal() { document.getElementById('modal').style.display = 'none'; }
function requestUserLocation() {
    if (!navigator.geolocation) return alert("Geolocation not supported.");
    navigator.geolocation.getCurrentPosition(pos => {
        userLat = pos.coords.latitude; userLng = pos.coords.longitude;
        document.getElementById('gps-btn').classList.add('active');
        document.getElementById('gps-btn').innerText = "üìç GPS Active";
    });
}

// Init
renderSchools(schools);
</script>
{% endblock %}