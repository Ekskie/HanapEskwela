{% extends 'base.html' %}
{% block title %}HanapEskwela ‚Äî Home{% endblock %}
{% block content %}
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<!-- Leaflet Routing Machine CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />

<style>
  .hero-section {
    background: linear-gradient(to right, #ffffff, #f1f8e9);
    padding: 60px 40px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #eee;
  }
  .hero-text h1 { font-size: 64px; color: #2E7D32; margin: 0; line-height: 1.1; }
  .hero-text p { font-size: 18px; color: #555; max-width: 600px; margin-top: 15px; }
  
  .search-container {
    padding: 20px;
    background: white;
    display: flex;
    justify-content: center;
    align-items: center; /* Center align items vertically */
    gap: 10px;
    position: sticky;
    top: 0;
    z-index: 900;
    box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
    flex-wrap: wrap; /* Allow wrapping on small screens */
  }
  .search-input { width: 300px; padding: 10px 15px; border-radius: 20px; border: 1px solid #ddd; outline: none; }
  .filter-select { padding: 10px; border-radius: 20px; border: 1px solid #ddd; }
  
  .gps-btn {
    padding: 10px 15px;
    border-radius: 20px;
    border: none;
    background: #FF9800;
    color: white;
    font-weight: bold;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 5px;
    transition: background 0.2s;
  }
  .gps-btn:hover { background: #F57C00; }
  .gps-btn.active { background: #4CAF50; }

  .grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 25px;
    padding: 40px;
    background: #f9f9f9;
    min-height: 500px;
  }
  
  .school-card {
    background: white;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    transition: transform 0.2s;
    cursor: pointer;
    position: relative;
  }
  .school-card:hover { transform: translateY(-5px); box-shadow: 0 8px 16px rgba(0,0,0,0.12); }
  .card-img { height: 150px; width: 100%; object-fit: cover; }
  .card-body { padding: 15px; }
  .card-title { margin: 0 0 5px 0; font-size: 18px; color: #333; }
  .card-meta { font-size: 13px; color: #666; display: flex; align-items: center; gap: 5px; margin-bottom: 5px; }
  
  .fav-icon {
    position: absolute;
    top: 10px;
    right: 10px;
    background: white;
    border-radius: 50%;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    color: #ccc;
    z-index: 2;
    cursor: pointer;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  }
  .fav-icon.active { color: #f44336; }

  /* Modal Styles */
  .modal-overlay {
    display: none;
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.7);
    z-index: 1000;
    justify-content: center;
    align-items: center;
    padding: 20px;
  }
  .modal-content {
    background: white;
    width: 100%;
    max-width: 900px;
    height: 90vh;
    border-radius: 16px;
    display: flex;
    overflow: hidden;
    position: relative;
    animation: zoomIn 0.3s;
  }
  .modal-left { width: 45%; background: #f5f5f5; display: flex; flex-direction: column; position: relative; }
  .modal-right { width: 55%; padding: 30px; overflow-y: auto; }
  
  .modal-img { width: 100%; height: 200px; object-fit: cover; }
  .map-container { flex: 1; background: #e0e0e0; position: relative; width: 100%; min-height: 250px; }
  #map { width: 100%; height: 100%; z-index: 1; }
  
  .modal-close {
    position: absolute;
    top: 20px;
    right: 20px;
    background: #eee;
    border: none;
    border-radius: 50%;
    width: 36px;
    height: 36px;
    cursor: pointer;
    font-size: 20px;
    z-index: 10;
  }
  
  .detail-row { margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 15px; }
  .detail-label { font-size: 12px; font-weight: bold; color: #2E7D32; text-transform: uppercase; display: block; margin-bottom: 4px; }
  
  .action-btn {
    display: inline-block;
    background: #2E7D32;
    color: white;
    padding: 12px 24px;
    border-radius: 8px;
    text-decoration: none;
    font-weight: 600;
    margin-top: 20px;
    text-align: center;
    font-size: 14px;
  }

  .nav-btn {
    background: #4285F4;
    margin-right: 10px;
  }
  .nav-btn:hover { background: #3367D6; }

  /* Styling for the Directions Panel inside the Map */
  .leaflet-routing-container {
    background-color: white;
    padding: 10px;
    max-height: 200px; /* Limit height so it doesn't cover the whole map */
    overflow-y: auto;
    width: 250px;
    font-size: 12px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    border-radius: 8px;
    opacity: 0.95;
  }
  
  /* Make the header of the routing smaller */
  .leaflet-routing-container h2 { font-size: 14px; margin-top: 0; }
  .leaflet-routing-container h3 { font-size: 13px; font-weight: normal; }
  
  .link-text { color: #1976D2; text-decoration: none; }
  .link-text:hover { text-decoration: underline; }

  @keyframes zoomIn { from {transform: scale(0.95); opacity: 0;} to {transform: scale(1); opacity: 1;} }
  @media (max-width: 768px) {
    .modal-content { flex-direction: column; height: auto; max-height: 90vh; overflow-y: auto; }
    .modal-left, .modal-right { width: 100%; }
    .modal-left { height: 300px; }
  }
</style>

<div class="search-container">
  <input class="search-input" id="search" placeholder="Search schools, courses..." oninput="filterSchools()">
  <select class="filter-select" id="filter" onchange="filterSchools()">
    <option value="all">All Types</option>
    <option value="public">Public</option>
    <option value="private">Private</option>
  </select>
  <select class="filter-select" id="favFilter" onchange="filterSchools()">
    <option value="all">All Schools</option>
    <option value="fav">My Favorites</option>
  </select>
  <!-- New Explicit GPS Button -->
  <button id="gps-btn" class="gps-btn" onclick="requestUserLocation()">
    üìç Enable GPS
  </button>
</div>

<div class="hero-section" id="hero">
  <div class="hero-text">
    <h1>Hanap Eskwela</h1>
    <p>Discover the best higher education institutions in Laguna. Compare tuition, location, and programs to find your perfect match.</p>
  </div>
  <div style="flex:1; max-width:400px; height:300px; background:#ddd; border-radius:12px; overflow:hidden;">
    <img src="https://d2nnykqiaju69u.cloudfront.net/pslife_photos/pat_temp/Laguna%20State%20Polytechnic%20University%20fire%20kill%20student%20inner%20image.jpg" style="width:100%; height:100%; object-fit:cover;">
  </div>
</div>

<div class="grid" id="schoolGrid">
  <!-- Filled by JS -->
</div>

<!-- Modal -->
<div class="modal-overlay" id="modal">
  <div class="modal-content">
    <button class="modal-close" onclick="closeModal()">&times;</button>
    
    <div class="modal-left">
      <img id="m-img" class="modal-img" src="">
      <div class="map-container">
        <div id="map"></div>
      </div>
    </div>
    
    <div class="modal-right">
      <h2 id="m-name" style="margin-top:0;">School Name</h2>
      <p id="m-desc" style="color:#555; line-height:1.6;"></p>
      
      <!-- External Navigation Link -->
      <a id="m-gmaps-link" href="#" target="_blank" class="action-btn nav-btn" style="display:none; width:100%; box-sizing:border-box;">
        üìç Open in Google Maps
      </a>

      <div style="display:flex; gap:20px; margin-top:20px; margin-bottom:20px;">
        <div><span class="detail-label">Type</span> <span id="m-type"></span></div>
        <div><span class="detail-label">Views</span> <span id="m-views"></span></div>
        <div><span class="detail-label">Status</span> <span id="m-slots"></span></div>
      </div>

      <div class="detail-row">
        <span class="detail-label">Location</span>
        <div id="m-addr"></div>
      </div>
      
      <div class="detail-row">
        <span class="detail-label">Programs</span>
        <div id="m-progs"></div>
      </div>

      <div class="detail-row">
        <span class="detail-label">Tuition Fee</span>
        <div id="m-tuition" style="color:#d84315; font-weight:bold;"></div>
      </div>

      <div class="detail-row">
        <span class="detail-label">Contact & Socials</span>
        <div>üìû <a id="m-contact" class="link-text" href="#"></a></div>
        <div>üåê <a id="m-socials" class="link-text" href="#" target="_blank"></a></div>
      </div>

      <a id="m-link" href="#" target="_blank" class="action-btn">Apply / Visit Website</a>
      
      <button id="m-fav-btn" class="action-btn" style="background:#f5f5f5; color:#333; margin-left:10px;" onclick="toggleModalFav()">
        Add to Favorites
      </button>
    </div>
  </div>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<!-- Leaflet Routing Machine JS -->
<script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>

<script>
const schools = {{ schools | tojson }};
let map = null;
let userLat = null;
let userLng = null;
let currentSchoolId = null;
let routingControl = null;

// Explicit Request Function attached to Button
function requestUserLocation() {
    const btn = document.getElementById('gps-btn');
    btn.innerHTML = "‚åõ Locating...";
    
    if (!navigator.geolocation) {
        alert("Your browser does not support Geolocation.");
        btn.innerHTML = "‚ùå Not Supported";
        return;
    }

    navigator.geolocation.getCurrentPosition(
        (pos) => {
            userLat = pos.coords.latitude;
            userLng = pos.coords.longitude;
            console.log("Location found:", userLat, userLng);
            
            btn.innerHTML = "üìç GPS Active";
            btn.classList.add('active');
            
            // If a school modal is already open, reload it to draw the route
            if (currentSchoolId) {
                openModal(currentSchoolId);
            }
        },
        (err) => { 
            console.error("Location Error:", err);
            let msg = "Unknown error.";
            switch(err.code) {
                case err.PERMISSION_DENIED:
                    msg = "Permission denied. Please allow location access in your browser settings.";
                    break;
                case err.POSITION_UNAVAILABLE:
                    msg = "Location information is unavailable. Check your GPS signal.";
                    break;
                case err.TIMEOUT:
                    msg = "The request to get user location timed out.";
                    break;
            }
            alert("Location Failed: " + msg);
            btn.innerHTML = "‚ö†Ô∏è Retry GPS";
        },
        { 
            enableHighAccuracy: true, 
            timeout: 15000, 
            maximumAge: 0 
        }
    );
}

function renderSchools(list) {
  const grid = document.getElementById('schoolGrid');
  grid.innerHTML = '';
  
  if(list.length === 0) {
    grid.innerHTML = '<p style="grid-column:1/-1; text-align:center;">No schools found.</p>';
    return;
  }

  list.forEach(s => {
    const div = document.createElement('div');
    div.className = 'school-card';
    div.onclick = (e) => {
      if(!e.target.classList.contains('fav-icon')) openModal(s.id);
    };
    div.innerHTML = `
      <div class="fav-icon ${s.is_fav ? 'active' : ''}" onclick="toggleFav('${s.id}', this)">‚ô•</div>
      <img src="${s.img}" class="card-img" onerror="this.src='https://via.placeholder.com/400x200'">
      <div class="card-body">
        <div class="school-type-badge">${s.type}</div>
        <h3 class="card-title">${s.name}</h3>
        <div class="card-meta">üìç ${s.place}</div>
        <div class="card-meta">üí∞ ${s.tuition}</div>
      </div>
    `;
    grid.appendChild(div);
  });
}

function filterSchools() {
  const q = document.getElementById('search').value.toLowerCase();
  const type = document.getElementById('filter').value;
  const fav = document.getElementById('favFilter').value;
  
  const hero = document.getElementById('hero');
  if (q || type !== 'all' || fav !== 'all') hero.style.display = 'none';
  else hero.style.display = 'flex';

  const filtered = schools.filter(s => {
    const matchQ = s.name.toLowerCase().includes(q) || (s.programs && s.programs.toLowerCase().includes(q));
    const matchType = type === 'all' || s.type === type;
    const matchFav = fav === 'all' || s.is_fav;
    return matchQ && matchType && matchFav;
  });
  renderSchools(filtered);
}

function toggleFav(id, btn) {
  fetch('/api/toggle_favorite', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({school_id: id})
  })
  .then(res => res.json())
  .then(data => {
    btn.classList.toggle('active');
    const s = schools.find(x => x.id === id);
    if(s) s.is_fav = !s.is_fav;
  });
}

function openModal(id) {
  const s = schools.find(x => x.id === id);
  if(!s) return;
  currentSchoolId = id;

  // Increment view count backend
  fetch('/api/view_school', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({school_id: id})
  }).then(r=>r.json()).then(d => {
      document.getElementById('m-views').innerText = d.views || s.views;
  });

  document.getElementById('modal').style.display = 'flex';
  document.body.style.overflow = 'hidden';

  // Populate info
  document.getElementById('m-name').innerText = s.name;
  document.getElementById('m-img').src = s.img;
  document.getElementById('m-desc').innerText = s.desc || 'No description.';
  document.getElementById('m-type').innerText = s.type.toUpperCase();
  document.getElementById('m-slots').innerText = s.slots;
  document.getElementById('m-addr').innerText = s.address;
  document.getElementById('m-progs').innerText = s.programs;
  document.getElementById('m-tuition').innerText = s.tuition;
  
  // Handle Contact
  const contactLink = document.getElementById('m-contact');
  const contactText = s.contact || 'N/A';
  contactLink.innerText = contactText;
  if(contactText !== 'N/A') {
      contactLink.href = `tel:${contactText.replace(/[^0-9]/g, '')}`;
  } else {
      contactLink.href = "#";
      contactLink.style.pointerEvents = 'none';
  }

  // Handle Socials
  const socialLink = document.getElementById('m-socials');
  const socialText = s.socials || 'N/A';
  socialLink.innerText = socialText;
  if(socialText !== 'N/A') {
      let url = socialText;
      if (!url.startsWith('http')) {
          url = 'https://' + url;
      }
      socialLink.href = url;
      socialLink.style.pointerEvents = 'auto';
  } else {
      socialLink.href = "#";
      socialLink.style.pointerEvents = 'none';
  }
  
  document.getElementById('m-link').href = s.link;
  
  const favBtn = document.getElementById('m-fav-btn');
  favBtn.innerText = s.is_fav ? "Remove Favorite" : "Add to Favorites";

  // Google Maps Link Logic
  const gLink = document.getElementById('m-gmaps-link');
  if (userLat && userLng && s.lat && s.lng) {
      // Create a Google Maps Directions URL
      const gmapsUrl = `https://www.google.com/maps/dir/?api=1&origin=${userLat},${userLng}&destination=${s.lat},${s.lng}&travelmode=driving`;
      gLink.href = gmapsUrl;
      gLink.style.display = 'inline-block';
      gLink.innerText = "üìç Open in Google Maps";
  } else {
      gLink.href = "#";
      gLink.style.display = 'inline-block';
      gLink.innerText = "üìç Enable GPS for Directions";
      gLink.onclick = (e) => {
          e.preventDefault();
          requestUserLocation();
      }
  }

  // Leaflet Map Logic
  setTimeout(() => {
    if (!map) {
      map = L.map('map').setView([14.2, 121.2], 10);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap'
      }).addTo(map);
    }
    
    // Resize map to fix rendering issues in hidden modals
    map.invalidateSize();

    // Clear previous routing and layers
    map.eachLayer((layer) => {
        if (!!layer.toGeoJSON) { map.removeLayer(layer); }
    });
    // Re-add tile layer
    if (routingControl) {
        map.removeControl(routingControl);
        routingControl = null;
    }
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    // School Marker
    const schoolLatLng = [s.lat || 14.2, s.lng || 121.1];
    L.marker(schoolLatLng).addTo(map).bindPopup(s.name).openPopup();

    // Routing Logic (User -> School)
    if (userLat && userLng && s.lat && s.lng) {
        // Add Marker for User
        L.marker([userLat, userLng]).addTo(map).bindPopup("You are here");

        // Calculate and Draw Route
        routingControl = L.Routing.control({
            waypoints: [
                L.latLng(userLat, userLng),
                L.latLng(s.lat, s.lng)
            ],
            router: L.Routing.osrmv1({
                serviceUrl: 'https://router.project-osrm.org/route/v1'
            }),
            lineOptions: {
                styles: [{color: '#2E7D32', opacity: 0.8, weight: 6}]
            },
            createMarker: function() { return null; }, // We already added custom markers
            addWaypoints: false,
            draggableWaypoints: false,
            fitSelectedRoutes: true,
            show: true, // SHOW TEXT DIRECTIONS
            collapsible: true // ALLOW COLLAPSING THE DIRECTIONS
        }).addTo(map);
    } else {
        if (!userLat && !userLng) {
           console.log("User location not available for routing.");
        }
        map.setView(schoolLatLng, 13);
    }
  }, 200);
}

function toggleModalFav() {
    const btn = document.getElementById('m-fav-btn');
    toggleFav(currentSchoolId, { classList: { toggle: ()=>{} } }); 
    const s = schools.find(x => x.id === currentSchoolId);
    setTimeout(() => {
        btn.innerText = s.is_fav ? "Remove Favorite" : "Add to Favorites";
    }, 100);
}

function closeModal() {
  document.getElementById('modal').style.display = 'none';
  document.body.style.overflow = 'auto';
}

// Init
renderSchools(schools);
</script>
{% endblock %}